<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack | Joe Leto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(ellipse at center, #14532d 0%, #0a0a0a 100%);
            color: #e0f7ff;
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .casino-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 5px;
        }

        .header p {
            font-size: 1rem;
            color: #b0bec5;
            font-weight: 400;
        }

        /* Casino Table */
        .casino-table {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #1b5e20 100%);
            border-radius: 150px 150px 30px 30px;
            padding: 25px 20px 40px;
            position: relative;
            box-shadow: 
                0 15px 30px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.1),
                inset 0 -2px 4px rgba(0,0,0,0.2);
            border: 6px solid #8d6e63;
            margin-bottom: 20px;
        }

        .table-border {
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: 150px 150px 30px 30px;
            background: linear-gradient(45deg, #8d6e63, #a1887f, #8d6e63);
            z-index: -1;
        }

        /* Game Areas - Tighter Layout */
        .game-areas {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }


        .dealer-area, .player-area {
            text-align: center;
        }

        .score {
            margin-top: 4px;
            font-size: 1rem;
            font-weight: 600;
            color: #e0f7ff;
        }

        .area-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        .hand-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            min-height: 100px;
            align-items: center;
        }

        /* Player Area with Betting Circle */
        .player-area {
            position: relative;
        }

        .betting-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, rgba(255,215,0,0.1) 70%, transparent 100%);
            border: 3px dashed rgba(255,215,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .betting-circle.has-bet {
            background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, rgba(255,215,0,0.2) 70%, transparent 100%);
            border-color: rgba(255,215,0,0.8);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .bet-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .player-hand-container {
            position: relative;
            z-index: 2;
        }

        /* Split Hands - Enhanced Visual Feedback */
        .split-hands {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .split-hand {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            border: 3px solid transparent;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .split-hand::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, transparent);
            border-radius: 15px;
            z-index: -1;
            transition: all 0.4s ease;
        }

        .split-hand.active {
            border-color: #00bcd4;
            background: rgba(0,188,212,0.15);
            box-shadow: 
                0 0 25px rgba(0,188,212,0.4),
                inset 0 0 15px rgba(0,188,212,0.1);
            transform: scale(1.02);
        }

        .split-hand.active::before {
            background: linear-gradient(45deg, 
                #00bcd4, #4dd0e1, #00bcd4, #4dd0e1, 
                #00bcd4, #4dd0e1, #00bcd4, #4dd0e1);
            animation: borderGlow 2s linear infinite;
        }

        @keyframes borderGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .split-hand-label {
            font-size: 1rem;
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .split-hand.active .split-hand-label {
            color: #00bcd4;
            text-shadow: 0 0 15px rgba(0,188,212,0.8);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .split-hand-score {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #e0f7ff;
        }

        .split-hand.active .split-hand-score {
            color: #00bcd4;
            text-shadow: 0 0 10px rgba(0,188,212,0.6);
        }

        /* Chips - More Compact */
        .chips-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chip {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 
                0 3px 6px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.3);
            -webkit-user-select: none;
            user-select: none;
        }

        .chip:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 5px 10px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.3),
                0 0 15px rgba(255,255,255,0.3);
        }

        .chip:active {
            transform: translateY(0) scale(0.95);
        }

        .chip-10 { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }
        .chip-25 { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .chip-100 { background: linear-gradient(45deg, #45b7d1, #96c93d); }
        .chip-500 { background: linear-gradient(45deg, #a55eea, #8b5cf6); }
        .chip-1000 { 
            background: linear-gradient(45deg, #ffd700, #ffed4e); 
            color: #000;
            font-weight: 800;
            border-color: #ffd700;
        }

        /* Cards - Slightly Smaller */
        .card {
            width: 100px;
            height: 145px;
            background: #fff;
            border-radius: 10px;
            border: 2px solid #bbb;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px 8px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        .card-value {
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1;
            max-width: 100%;
            overflow: hidden;
        }

        .card-suit {
            font-size: 1.1rem;
            line-height: 1;
            max-width: 100%;
            max-height: 1.2em;
            overflow: hidden;
        }

        .card-center {
            text-align: center;
            font-size: 1.5rem;
            line-height: 1;
            margin: 0.2em 0;
            max-width: 100%;
            max-height: 1.6em;
            overflow: hidden;
        }

        .card.red .card-value,
        .card.red .card-suit,
        .card.red .card-center {
            color: #e74c3c;
        }

        .card.black .card-value,
        .card.black .card-suit,
        .card.black .card-center {
            color: #222;
        }

        /* Controls - More Compact */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00bcd4, #0097a7);
            color: white;
            box-shadow: 0 3px 12px rgba(0,188,212,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,188,212,0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #4caf50, #388e3c);
            color: white;
            box-shadow: 0 3px 12px rgba(76,175,80,0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            box-shadow: 0 3px 12px rgba(255,152,0,0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,152,0,0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 3px 12px rgba(244,67,54,0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244,67,54,0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Status - More Compact */
        .game-status {
            text-align: center;
            padding: 18px 10px;
            border-radius: 12px;
            margin: 18px 0;
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            min-height: 2.5em;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            opacity: 0;
            transform: translateY(20px);
            animation: statusFadeIn 0.5s forwards;
        }
        @keyframes statusFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .status-win {
            background: linear-gradient(90deg, #4caf50 60%, #a5d6a7 100%);
            border: 2px solid #388e3c;
            color: #fff;
            text-shadow: 0 2px 8px #388e3c;
        }
        .status-lose {
            background: linear-gradient(90deg, #f44336 60%, #ffb3b3 100%);
            border: 2px solid #b71c1c;
            color: #fff;
            text-shadow: 0 2px 8px #b71c1c;
        }
        .status-blackjack {
            background: linear-gradient(90deg, #ffd700 60%, #fffde7 100%);
            border: 2px solid #ffd700;
            color: #222;
            text-shadow: 0 2px 8px #ffd700;
        }
        .status-push {
            background: linear-gradient(90deg, #ff9800 60%, #ffe0b2 100%);
            border: 2px solid #ff9800;
            color: #fff;
            text-shadow: 0 2px 8px #ff9800;
        }
        .status-playing {
            background: linear-gradient(90deg, #00bcd4 60%, #b2ebf2 100%);
            border: 2px solid #00bcd4;
            color: #fff;
            text-shadow: 0 2px 8px #00bcd4;
        }
        /* Loading spinner only after 200ms */
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }
        .loading.show {
            display: block;
        }

        /* Game Info - Moved to Bottom, More Compact */
        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,215,0,0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .info-panel h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .info-value {
            font-weight: 600;
            color: #e0f7ff;
        }

        .info-value.positive {
            color: #4caf50;
            animation: pulse 0.5s ease-in-out;
        }

        .info-value.negative {
            color: #f44336;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Loading */
        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255,215,0,0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .casino-container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .casino-table {
                border-radius: 80px 80px 20px 20px;
                padding: 15px 10px 25px;
            }

            .table-border {
                border-radius: 80px 80px 20px 20px;
            }

            .betting-circle {
                width: 70px;
                height: 70px;
            }

            .bet-amount {
                font-size: 1rem;
            }

            .chip {
                width: 45px;
                height: 45px;
                font-size: 0.7rem;
            }

            .card {
                width: 55px;
                height: 77px;
                padding: 5px;
            }

            .card-value {
                font-size: 0.9rem;
            }

            .card-suit {
                font-size: 1.1rem;
            }

            .card-center {
                font-size: 1.3rem;
            }

            .game-controls {
                gap: 8px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 0.8rem;
            }

            .split-hands {
                grid-template-columns: 1fr;
            }

            .game-info {
                grid-template-columns: 1fr;
            }

            .score {
                font-size: 0.9rem;
            }
        }

        /* Animations */
        .card-deal {
            animation: dealCard 0.5s ease-out;
        }

        @keyframes dealCard {
            from {
                transform: translateX(-100px) rotateY(90deg);
                opacity: 0;
            }
            to {
                transform: translateX(0) rotateY(0deg);
                opacity: 1;
            }
        }

        .chip-place {
            animation: placeChip 0.3s ease-out;
        }

        @keyframes placeChip {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="casino-container">
        <div class="header">
            <h1>‚ô†Ô∏è Blackjack ‚ô•Ô∏è</h1>
            <p>Professional Casino Experience</p>
        </div>

        <div class="casino-table">
            <div class="table-border"></div>
            
            <!-- Chips -->
            <div class="chips-container" id="chipsContainer">
                <div class="chip chip-10" data-value="10">$10</div>
                <div class="chip chip-25" data-value="25">$25</div>
                <div class="chip chip-100" data-value="100">$100</div>
                <div class="chip chip-500" data-value="500">$500</div>
                <div class="chip chip-1000" data-value="1000">$1K</div>
            </div>
            
            <!-- Game Areas -->
            <div class="game-areas">
                <!-- Dealer Area -->
                <div class="dealer-area">
                    <div class="area-label">Dealer</div>
                    <div class="hand-container" id="dealerHand">
                        <!-- Dealer cards will be rendered here -->
                    </div>
                    <div class="score" id="dealerScore"></div>
                </div>

                <!-- Player Area -->
                <div class="player-area">
                    <div class="area-label">Player</div>
                    
                    <!-- Betting Circle Behind Player Cards -->
                    <div class="betting-circle" id="bettingCircle">
                        <div class="bet-amount" id="betAmount">$0</div>
                    </div>
                    
                    <div class="player-hand-container">
                        <div class="hand-container" id="playerHand">
                            <!-- Player cards will be rendered here -->
                        </div>
                        <div class="score" id="playerScore"></div>

                        <!-- Split Hands Container -->
                        <div class="split-hands" id="splitHands" style="display: none;">
                            <!-- Split hands will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="game-controls">
                <button class="btn btn-primary" id="newHandBtn" onclick="startNewHand()">Next Hand</button>
                <button class="btn btn-primary" id="hitBtn" onclick="playerHit()" disabled>Hit</button>
                <button class="btn btn-primary" id="standBtn" onclick="playerStand()" disabled>Stand</button>
                <button class="btn btn-warning" id="doubleBtn" onclick="playerDouble()" disabled>Double</button>
                <button class="btn btn-success" id="splitBtn" onclick="playerSplit()" disabled>Split</button>
                <button class="btn btn-danger" id="surrenderBtn" onclick="playerSurrender()" disabled>Surrender</button>
                <button class="btn btn-warning" id="insuranceBtn" onclick="takeInsurance()" disabled>Insurance</button>
            </div>

            <!-- Game Status -->
            <div class="game-status status-playing" id="gameStatus">
                Place your bet to start playing!
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <div class="info-panel">
                <h3>üí∞ Bankroll</h3>
                <div class="info-item">
                    <span>Current:</span>
                    <span class="info-value" id="bankrollDisplay">$1,000</span>
                </div>
                <div class="info-item">
                    <span>Change:</span>
                    <span class="info-value" id="bankrollChange">$0</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>üìä Statistics</h3>
                <div class="info-item">
                    <span>Games Played:</span>
                    <span class="info-value" id="gamesPlayed">0</span>
                </div>
                <div class="info-item">
                    <span>Games Won:</span>
                    <span class="info-value" id="gamesWon">0</span>
                </div>
                <div class="info-item">
                    <span>Win Rate:</span>
                    <span class="info-value" id="winRate">0%</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>üéÆ Session</h3>
                <button class="btn btn-primary" onclick="startNewSession()" style="width: 100%; margin-top: 10px;">New Session</button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Processing...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://5er4v2u3n7.execute-api.us-east-1.amazonaws.com/prod/blackjack';
        
        let gameState = {
            gameId: null,
            playerCards: [],
            dealerCards: [],
            hands: [],
            currentHandIndex: 0,
            gameOver: false,
            playerTurn: true,
            canDouble: false,
            canSplit: false,
            canSurrender: false,
            canInsure: false,
            currentBet: 0,
            bankroll: 1000,
            userId: null,
            splitBets: [],
            gamesPlayed: 0,
            gamesWon: 0,
            lastBankroll: 1000
        };

        // MOVE THESE UTILITY FUNCTIONS TO THE TOP
        function updateStatus(message, statusClass = 'status-playing') {
            const statusElement = document.getElementById('gameStatus');
            statusElement.textContent = message;
            statusElement.className = `game-status ${statusClass}`;
        }

        function setLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                if (show) {
                    loadingElement.classList.add('show');
                } else {
                    loadingElement.classList.remove('show');
                }
            }
        }

        function disableGameControls() {
            document.getElementById('hitBtn').disabled = true;
            document.getElementById('standBtn').disabled = true;
            document.getElementById('doubleBtn').disabled = true;
            document.getElementById('splitBtn').disabled = true;
            document.getElementById('surrenderBtn').disabled = true;
            document.getElementById('insuranceBtn').disabled = true;
        }

        function enableGameControls() {
            document.getElementById('hitBtn').disabled = false;
            document.getElementById('standBtn').disabled = false;
            document.getElementById('doubleBtn').disabled = !gameState.canDouble;
            document.getElementById('splitBtn').disabled = !gameState.canSplit;
            document.getElementById('surrenderBtn').disabled = !gameState.canSurrender;
            document.getElementById('insuranceBtn').disabled = !gameState.canInsure;
            
            // For split hands, update button states based on current hand
            if (gameState.hands.length > 0) {
                const currentHand = gameState.hands[gameState.currentHandIndex];
                const handValue = calculateHandValue(currentHand);
                
                // Disable double if hand has more than 2 cards or if busted
                if (currentHand.length > 2 || handValue > 21) {
                    document.getElementById('doubleBtn').disabled = true;
                }
                
                // Can't split after initial split or if busted
                document.getElementById('splitBtn').disabled = true;
                document.getElementById('surrenderBtn').disabled = true;
                document.getElementById('insuranceBtn').disabled = true;
            }
        }

        function saveSessionState() {
            localStorage.setItem('blackjackGameState', JSON.stringify(gameState));
        }

        function loadSessionState() {
            const saved = localStorage.getItem('blackjackGameState');
            if (saved) {
                try {
                    const parsedState = JSON.parse(saved);
                    gameState = { ...gameState, ...parsedState };
                } catch (error) {
                    console.error('Error loading session state:', error);
                }
            }
        }

        function updateStatsUI() {
            document.getElementById('gamesPlayed').textContent = gameState.gamesPlayed;
            document.getElementById('gamesWon').textContent = gameState.gamesWon;
            const winRate = gameState.gamesPlayed > 0 ? 
                Math.round((gameState.gamesWon / gameState.gamesPlayed) * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            loadSessionState();
            updateStatsUI();
            if (!gameState.userId) {
                startNewSession();
            } else {
                updateDisplay();
                updateBankrollDisplay();
                loadStats();
                disableGameControls();
                updateStatus('Session loaded! Place a bet to continue playing.');
            }
            
            // Add chip click handlers
            setupChipHandlers();
        });

        function setupChipHandlers() {
            const chips = document.querySelectorAll('.chip');
            console.log('Setting up chip handlers for', chips.length, 'chips');
            chips.forEach(chip => {
                chip.addEventListener('click', function() {
                    const value = parseInt(this.dataset.value);
                    console.log('Chip clicked:', value);
                    addToBet(value);
                });
            });
        }

        // Remove all client-side bankroll manipulation
        function addToBet(amount) {
            console.log('addToBet called with amount:', amount);
            
            // Only allow betting if no hand is in progress
            if (gameState.gameId && !gameState.gameOver) {
                console.log('Betting blocked - hand in progress');
                updateStatus('Cannot change bet during a hand!');
                return;
            }
            
            // Don't check bankroll client-side - let server validate
            gameState.currentBet += amount;
            console.log('Bet updated:', gameState.currentBet);
            updateBetDisplay();
            updateStatus(`Bet placed: $${gameState.currentBet}! Click "Next Hand" to start.`);
        }

        function updateBetDisplay() {
            const betAmount = document.getElementById('betAmount');
            const bettingCircle = document.getElementById('bettingCircle');
            
            if (gameState.currentBet > 0) {
                betAmount.textContent = `$${gameState.currentBet}`;
                bettingCircle.classList.add('has-bet');
            } else {
                betAmount.textContent = '$0';
                bettingCircle.classList.remove('has-bet');
            }
        }

        function renderCard(card, isHidden = false) {
            if (isHidden) {
                return '<div class="card hidden"></div>';
            }

            const isRed = card.suit === '‚ô•Ô∏è' || card.suit === '‚ô¶Ô∏è';
            const cardClass = isRed ? 'card red' : 'card black';
            
            let cardContent = '';
            
            if (card.rank === 'A') {
                cardContent = `
                    <div class="card-value">A</div>
                    <div class="card-suit">${card.suit}</div>
                    <div class="card-center">${card.suit}</div>
                    <div class="card-suit" style="transform: rotate(180deg);">${card.suit}</div>
                    <div class="card-value" style="transform: rotate(180deg);">A</div>
                `;
            } else if (['J', 'Q', 'K'].includes(card.rank)) {
                const faceSymbol = card.rank === 'J' ? 'üë®' : card.rank === 'Q' ? 'üë∏' : 'üëë';
                cardContent = `
                    <div class="card-value">${card.rank}</div>
                    <div class="card-suit">${card.suit}</div>
                    <div class="card-center">${faceSymbol}</div>
                    <div class="card-suit" style="transform: rotate(180deg);">${card.suit}</div>
                    <div class="card-value" style="transform: rotate(180deg);">${card.rank}</div>
                `;
            } else {
                const rank = card.rank;
                const suit = card.suit;
                cardContent = `
                    <div class="card-value">${rank}</div>
                    <div class="card-suit">${suit}</div>
                    <div class="card-center">${suit}</div>
                    <div class="card-suit" style="transform: rotate(180deg);">${suit}</div>
                    <div class="card-value" style="transform: rotate(180deg);">${rank}</div>
                `;
            }
            
            return `<div class="card ${cardClass} card-deal">${cardContent}</div>`;
        }

        function renderHand(cards, isHidden = false) {
            return cards.map(card => renderCard(card, isHidden)).join('');
        }

        function calculateHandValue(cards) {
            let value = 0;
            let aces = 0;
            cards.forEach(card => {
                if (card.rank === 'A') {
                    value += 11;
                    aces++;
                } else if (['J', 'Q', 'K'].includes(card.rank)) {
                    value += 10;
                } else {
                    value += parseInt(card.rank);
                }
            });
            while (value > 21 && aces > 0) {
                value -= 10;
                aces--;
            }
            return value;
        }

        function getCurrentPlayerHand() {
            return gameState.hands.length > 0 ? gameState.hands[gameState.currentHandIndex] : gameState.playerCards;
        }

        function updateScores() {
            const playerScoreEl = document.getElementById('playerScore');
            const dealerScoreEl = document.getElementById('dealerScore');

            if (gameState.hands.length > 0) {
                // For split hands, show current hand score
                const currentHand = gameState.hands[gameState.currentHandIndex];
                playerScoreEl.textContent = currentHand.length ? calculateHandValue(currentHand) : '';
            } else {
                // For single hand
                const playerHand = gameState.playerCards;
                playerScoreEl.textContent = playerHand.length ? calculateHandValue(playerHand) : '';
            }

            const showDealerCards = !gameState.playerTurn || gameState.gameOver;
            if (!showDealerCards) {
                dealerScoreEl.textContent = '?';
            } else {
                dealerScoreEl.textContent = gameState.dealerCards.length ? calculateHandValue(gameState.dealerCards) : '';
            }
        }

        function renderSplitHands() {
            const splitHandsContainer = document.getElementById('splitHands');
            const playerHand = document.getElementById('playerHand');
            
            playerHand.style.display = 'none';
            splitHandsContainer.style.display = 'grid';
            
            splitHandsContainer.innerHTML = gameState.hands.map((hand, index) => {
                const isActive = index === gameState.currentHandIndex && !gameState.gameOver;
                const bet = gameState.splitBets[index] || gameState.originalBet || 0;
                const handValue = calculateHandValue(hand);
                const handStatus = handValue > 21 ? ' (BUST)' : handValue === 21 ? ' (21!)' : '';
                
                return `
                    <div class="split-hand ${isActive ? 'active' : ''}" data-hand-index="${index}">
                        <div class="split-hand-label">
                            Hand ${index + 1} - Bet: $${bet}
                            ${isActive ? ' üëà PLAYING' : ''}
                        </div>
                        <div class="hand-container">
                            ${renderHand(hand)}
                        </div>
                        <div class="split-hand-score">
                            Score: ${handValue}${handStatus}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSingleHand() {
            const playerHand = document.getElementById('playerHand');
            const splitHandsContainer = document.getElementById('splitHands');
            
            // Show single hand, hide split hands
            playerHand.style.display = 'flex';
            splitHandsContainer.style.display = 'none';
            
            // Render the player's cards
            playerHand.innerHTML = renderHand(gameState.playerCards);
        }

        function updateDisplay() {
            // Render dealer hand
            const dealerHand = document.getElementById('dealerHand');
            const dealerCards = gameState.dealerCards;
            const showDealerCards = !gameState.playerTurn || gameState.gameOver;
            
            if (dealerCards.length > 0) {
                const firstCard = renderCard(dealerCards[0], false);
                const remainingCards = dealerCards.slice(1).map(card => 
                    renderCard(card, !showDealerCards)
                ).join('');
                dealerHand.innerHTML = firstCard + remainingCards;
            } else {
                dealerHand.innerHTML = '';
            }

            // Render player hand or split hands
            if (gameState.hands.length > 0) {
                renderSplitHands();
                // Update status to show which hand is active
                if (!gameState.gameOver && gameState.playerTurn) {
                    const currentHandIndex = gameState.currentHandIndex + 1;
                    const totalHands = gameState.hands.length;
                    updateStatus(`Playing Hand ${currentHandIndex} of ${totalHands} - Choose your action!`);
                }
            } else {
                renderSingleHand();
            }

            updateScores();
        }

        function updateBankrollDisplay() {
            const bankrollDisplay = document.getElementById('bankrollDisplay');
            const bankrollChange = document.getElementById('bankrollChange');
            
            // Always use server-provided bankroll
            bankrollDisplay.textContent = `$${gameState.bankroll.toLocaleString()}`;
            
            // Calculate change if we have bankrollChange from server
            if (gameState.bankrollChange !== undefined) {
                const changeText = gameState.bankrollChange > 0 ? `+$${gameState.bankrollChange}` : `$${gameState.bankrollChange}`;
                const changeClass = gameState.bankrollChange > 0 ? 'positive' : 'negative';
                bankrollChange.textContent = changeText;
                bankrollChange.className = `info-value ${changeClass}`;
                
                // Reset after showing
                setTimeout(() => {
                    bankrollChange.textContent = '$0';
                    bankrollChange.className = 'info-value';
                    gameState.bankrollChange = undefined;
                }, 3000);
            }
            
            saveSessionState();
        }

        async function startNewHand() {
            console.log('startNewHand called, currentBet:', gameState.currentBet);
            console.log('gameId:', gameState.gameId, 'gameOver:', gameState.gameOver);
            
            if (gameState.currentBet <= 0) {
                updateStatus('Please place a bet first!');
                return;
            }
            
            // Prevent starting new hand if one is already in progress
            if (gameState.gameId && !gameState.gameOver) {
                updateStatus('Cannot start new hand while one is in progress!');
                return;
            }
            
            try {
                setLoading(true);
                console.log('Sending request to:', API_URL);
                console.log('Request body:', { 
                    action: 'newGame',
                    playerId: gameState.userId,
                    bet: gameState.currentBet
                });
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'newGame',
                        playerId: gameState.userId,
                        bet: gameState.currentBet
                    })
                });
                
                console.log('Response status:', response.status);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.error) {
                    updateStatus(data.error);
                    // Reset bet if server rejected it
                    gameState.currentBet = 0;
                    updateBetDisplay();
                    return;
                }
                
                // CRITICAL: Always use server bankroll
                gameState.bankroll = data.bankroll;
                
                // Update game state from backend
                gameState = {
                    ...gameState,
                    gameId: data.gameState.gameId,
                    playerCards: data.gameState.playerCards || [],
                    dealerCards: data.gameState.dealerCards || [],
                    hands: data.gameState.hands || [],
                    currentHandIndex: data.gameState.currentHandIndex || 0,
                    gameOver: data.gameState.gameOver || false,
                    playerTurn: data.gameState.playerTurn !== undefined ? data.gameState.playerTurn : true,
                    canDouble: data.gameState.canDouble || false,
                    canSplit: data.gameState.canSplit || false,
                    canSurrender: data.gameState.canSurrender || false,
                    canInsure: data.gameState.canInsure || false,
                    splitBets: data.gameState.splitBets || []
                };
                
                console.log('Updated gameState:', gameState);
                
                updateDisplay();
                updateBankrollDisplay();
                
                // Only reset bet if game started successfully
                gameState.currentBet = 0;
                updateBetDisplay();
                
                if (data.result) {
                    handleGameEnd(data.result);
                } else {
                    enableGameControls();
                    updateStatus('Your turn! Choose your action.');
                }
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error starting new hand. Please try again.');
                // Reset bet on error
                gameState.currentBet = 0;
                updateBetDisplay();
            } finally {
                setLoading(false);
            }
        }

        async function playerHit() {
            if (!gameState.gameId) return;
            
            try {
                setLoading(true);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'hit',
                        gameId: gameState.gameId,
                        playerId: gameState.userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(data.error);
                    return;
                }

                // Update game state and bankroll from server
                gameState = { ...gameState, ...data.gameState };
                if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                if (data.bankrollChange !== undefined) gameState.bankrollChange = data.bankrollChange;
                
                updateDisplay();
                updateBankrollDisplay();
                
                if (data.result) {
                    handleGameEnd(data.result);
                } else {
                    enableGameControls();
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error making move. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        async function playerStand() {
            if (!gameState.gameId) return;
            
            try {
                setLoading(true);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'stand',
                        gameId: gameState.gameId,
                        playerId: gameState.userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(data.error);
                    return;
                }

                gameState = { ...gameState, ...data.gameState };
                if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                if (data.bankrollChange !== undefined) gameState.bankrollChange = data.bankrollChange;
                
                updateDisplay();
                updateBankrollDisplay();
                
                if (data.result) {
                    handleGameEnd(data.result);
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error making move. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        async function playerDouble() {
            if (!gameState.gameId) return;
            
            try {
                setLoading(true);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'double',
                        gameId: gameState.gameId,
                        playerId: gameState.userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(data.error);
                    if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                    updateBankrollDisplay();
                    return;
                }

                gameState = { ...gameState, ...data.gameState };
                if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                if (data.bankrollChange !== undefined) gameState.bankrollChange = data.bankrollChange;
                
                updateDisplay();
                updateBankrollDisplay();
                
                if (data.result) {
                    handleGameEnd(data.result);
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error making move. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        async function playerSplit() {
            if (!gameState.gameId) return;
            
            try {
                setLoading(true);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'split',
                        gameId: gameState.gameId,
                        playerId: gameState.userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(data.error);
                    if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                    updateBankrollDisplay();
                    return;
                }

                gameState = { ...gameState, ...data.gameState };
                if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                if (data.bankrollChange !== undefined) gameState.bankrollChange = data.bankrollChange;
                
                updateDisplay();
                updateBankrollDisplay();
                enableGameControls();
                updateStatus('Split completed! Continue playing your hands.');

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error making move. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        async function playerSurrender() {
            if (!gameState.gameId) return;
            
            try {
                setLoading(true);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'surrender',
                        gameId: gameState.gameId,
                        playerId: gameState.userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(data.error);
                    return;
                }

                gameState = { ...gameState, ...data.gameState };
                if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                if (data.bankrollChange !== undefined) gameState.bankrollChange = data.bankrollChange;
                
                updateDisplay();
                updateBankrollDisplay();
                
                if (data.result) {
                    handleGameEnd(data.result);
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error making move. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        async function takeInsurance() {
            if (!gameState.gameId) return;
            
            try {
                setLoading(true);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'insurance',
                        gameId: gameState.gameId,
                        playerId: gameState.userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(data.error);
                    if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                    updateBankrollDisplay();
                    return;
                }

                gameState = { ...gameState, ...data.gameState };
                if (data.bankroll !== undefined) gameState.bankroll = data.bankroll;
                if (data.bankrollChange !== undefined) gameState.bankrollChange = data.bankrollChange;
                
                updateDisplay();
                updateBankrollDisplay();
                
                if (data.result) {
                    handleGameEnd(data.result);
                } else {
                    enableGameControls();
                    updateStatus('Insurance taken! Continue playing.');
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error making move. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        function handleGameEnd(result) {
            disableGameControls();
            let statusClass = 'status-push';
            let message = '';
            let won = false;
            
            if (typeof result === 'object') {
                if (result.type === 'split') {
                    message = 'üéØ SPLIT RESULTS:\n';
                    let totalPayout = 0;
                    
                    result.results.forEach((handResult, index) => {
                        const handNumber = index + 1;
                        const resultText = handResult.result.toUpperCase();
                        const payout = handResult.payout;
                        totalPayout += payout;
                        
                        if (payout > 0) {
                            message += `Hand ${handNumber}: ${resultText} (+$${payout})\n`;
                            if (handResult.result === 'win' || handResult.result === 'blackjack') won = true;
                        } else if (payout < 0) {
                            message += `Hand ${handNumber}: ${resultText} (-$${Math.abs(payout)})\n`;
                        } else {
                            message += `Hand ${handNumber}: ${resultText} (Push)\n`;
                        }
                    });
                    
                    message += `\nTotal Change: ${totalPayout >= 0 ? '+' : ''}$${totalPayout}`;
                    statusClass = totalPayout > 0 ? 'status-win' : totalPayout < 0 ? 'status-lose' : 'status-push';
                } else {
                    const handResult = result.result;
                    if (handResult.result === 'blackjack') {
                        message = 'üÉè BLACKJACK! üéâ';
                        statusClass = 'status-blackjack';
                        won = true;
                    } else if (handResult.result === 'win') {
                        message = 'üéâ YOU WIN! üéâ';
                        statusClass = 'status-win';
                        won = true;
                    } else if (handResult.result === 'lose') {
                        message = 'üòî DEALER WINS';
                        statusClass = 'status-lose';
                    } else if (handResult.result === 'push') {
                        message = 'ü§ù PUSH - ITS A TIE!';
                        statusClass = 'status-push';
                    } else if (handResult.result === 'surrender') {
                        message = 'üè≥Ô∏è SURRENDERED';
                        statusClass = 'status-lose';
                    }
                }
            } else {
                // Handle simple string results (like immediate blackjack)
                if (result === 'blackjack') {
                    message = 'üÉè BLACKJACK! üéâ';
                    statusClass = 'status-blackjack';
                    won = true;
                } else if (result === 'win') {
                    message = 'üéâ YOU WIN! üéâ';
                    statusClass = 'status-win';
                    won = true;
                } else if (result === 'lose') {
                    message = 'üòî DEALER WINS';
                    statusClass = 'status-lose';
                } else if (result === 'push') {
                    message = 'ü§ù PUSH - ITS A TIE!';
                    statusClass = 'status-push';
                } else if (result === 'surrender') {
                    message = 'üè≥Ô∏è SURRENDERED';
                    statusClass = 'status-lose';
                }
            }
            
            // Update stats
            gameState.gamesPlayed++;
            if (won) gameState.gamesWon++;
            
            // Mark game as over and reset gameId to allow new bets
            gameState.gameOver = true;
            gameState.gameId = null;
            
            saveSessionState();
            updateStatsUI();
            updateStatus(message, statusClass);
            
            // Enable "Next Hand" button for new game
            document.getElementById('newHandBtn').disabled = false;
        }

        async function startNewSession() {
            gameState = {
                gameId: null,
                playerCards: [],
                dealerCards: [],
                hands: [],
                currentHandIndex: 0,
                gameOver: false,
                playerTurn: true,
                canDouble: false,
                canSplit: false,
                canSurrender: false,
                canInsure: false,
                currentBet: 0,
                bankroll: 1000,
                userId: null,
                splitBets: [],
                gamesPlayed: 0,
                gamesWon: 0,
                lastBankroll: 1000
            };
            
            // Generate new user ID
            gameState.userId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            
            saveSessionState();
            updateDisplay();
            updateBankrollDisplay();
            updateStatsUI();
            disableGameControls();
            updateStatus('New session started! Place a bet to begin playing.');
        }

        function saveSessionState() {
            localStorage.setItem('blackjackGameState', JSON.stringify(gameState));
        }

        function loadSessionState() {
            const saved = localStorage.getItem('blackjackGameState');
            if (saved) {
                try {
                    const parsedState = JSON.parse(saved);
                    gameState = { ...gameState, ...parsedState };
                } catch (error) {
                    console.error('Error loading session state:', error);
                }
            }
        }

        function updateStatsUI() {
            document.getElementById('gamesPlayed').textContent = gameState.gamesPlayed;
            document.getElementById('gamesWon').textContent = gameState.gamesWon;
            const winRate = gameState.gamesPlayed > 0 ? 
                Math.round((gameState.gamesWon / gameState.gamesPlayed) * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
        }

        async function loadStats() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getStats' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Could display global stats if desired
                }
            } catch (error) {
                console.log('Could not load stats');
            }
        }
    </script>
</body>
</html>
